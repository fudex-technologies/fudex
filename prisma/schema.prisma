generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                String             @id @default(uuid())
  name              String
  email             String             @unique
  emailVerified     Boolean            @default(false)
  image             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  firstName         String?
  lastName          String?
  phone             String?            @unique
  phoneVerified     Boolean            @default(false)
  referralCode      String?            @unique // Unique code for sharing
  addresses         Address[]
  favoriteVendors   FavoriteVendor[]
  operator          Operator?
  orders            Order[]
  payments          Payment[]
  payoutBatches     PayoutBatch[]
  reviews           Review[]
  roles             UserRole[]
  vendors           Vendor[]           @relation("VendorOwner")
  approvedVendors   Vendor[]           @relation("VendorApprovedBy")
  accounts          Account[]
  sessions          Session[]
  vendorPayouts     VendorPayout[]
  referrals         Referral[]         @relation("ReferrerReferrals") // People I referred
  referredBy        Referral?          @relation("ReferredByReferrals") // Who referred me
  pushSubscriptions PushSubscription[]

  @@map("user")
}

model UserRole {
  id         String   @id @default(uuid())
  userId     String
  role       Role
  assignedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@index([userId, role])
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Area {
  id                String             @id @default(uuid())
  name              String
  state             String
  meta              Json?
  createdAt         DateTime           @default(now())
  addresses         Address[]
  vendors           Vendor[]           @relation("AreaVendors") // Add relation name
  riderRequestItems RiderRequestItem[]
  deliveryFees      DeliveryFeeRule[]
  operators         Operator[]

  @@unique([name, state])
  @@index([state])
}

model DeliveryFeeRule {
  id        String   @id @default(uuid())
  areaId    String
  startTime String
  endTime   String
  fee       Float
  createdAt DateTime @default(now())
  area      Area     @relation(fields: [areaId], references: [id], onDelete: Cascade)

  @@index([areaId])
}

model RiderRequest {
  id               String             @id @default(uuid())
  vendorId         String
  operatorId       String?
  assignedRiderId  String?
  status           RiderRequestStatus @default(PENDING)
  settlementStatus SettlementStatus   @default(UNSETTLED)
  totalFee         Float              @default(0)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  vendor        Vendor             @relation(fields: [vendorId], references: [id])
  operator      Operator?          @relation(fields: [operatorId], references: [id])
  assignedRider Rider?             @relation(fields: [assignedRiderId], references: [id])
  items         RiderRequestItem[]

  @@index([vendorId])
  @@index([status])
  @@index([settlementStatus])
}

model RiderRequestItem {
  id              String   @id @default(uuid())
  riderRequestId  String
  customerName    String
  customerPhone   String
  customerAddress String
  areaId          String
  deliveryFee     Float
  createdAt       DateTime @default(now())

  riderRequest RiderRequest @relation(fields: [riderRequestId], references: [id], onDelete: Cascade)
  area         Area         @relation(fields: [areaId], references: [id])

  @@index([riderRequestId])
  @@index([areaId])
}

model Operator {
  id            String         @id @default(uuid())
  userId        String         @unique
  areaId        String?
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  area          Area?          @relation(fields: [areaId], references: [id])
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders        Order[]
  riders        Rider[]
  riderRequests RiderRequest[]

  @@index([areaId])
}

model Rider {
  id            String         @id @default(uuid())
  operatorId    String?
  name          String
  phone         String?
  isActive      Boolean        @default(true)
  notes         String?
  createdAt     DateTime       @default(now())
  orders        Order[]
  operator      Operator?      @relation(fields: [operatorId], references: [id])
  riderRequests RiderRequest[]

  @@index([operatorId])
  @@index([isActive])
}

model Address {
  id         String   @id @default(uuid())
  userId     String
  vendorId   String? // New field to link Address to Vendor
  label      String?
  line1      String
  line2      String?
  city       String
  state      String?
  postalCode String?
  country    String   @default("NG")
  lat        Float?
  lng        Float?
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  areaId     String?
  customArea String?
  area       Area?    @relation(fields: [areaId], references: [id])
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendor     Vendor?  @relation(fields: [vendorId], references: [id]) // New relation to Vendor
  orders     Order[]

  @@index([userId])
  @@index([vendorId]) // Index for vendorId
}

model Vendor {
  id                 String                   @id @default(uuid())
  ownerId            String?
  name               String
  slug               String                   @unique
  description        String?
  phone              String?
  email              String?
  coverImage         String?
  createdAt          DateTime                 @default(now())
  reviewsAverage     Float                    @default(0)
  reviewsCount       Int                      @default(0)
  bankAccountNumber  String?
  bankCode           String?
  bankName           String?
  bankAccountName    String?
  payoutEnabled      Boolean                  @default(false)
  paystackRecipient  String?
  availabilityStatus VendorAvailabilityStatus @default(AUTO)
  favoritedBy        FavoriteVendor[]
  orders             Order[]
  products           Product[]
  productItems       ProductItem[]
  reviews            Review[]
  owner              User?                    @relation("VendorOwner", fields: [ownerId], references: [id])
  vendorCategories   VendorCategory[]
  openingHours       VendorOpeningHour[]
  vendorPayouts      VendorPayout[]
  areaId             String? // Add missing areaId field
  area               Area?                    @relation("AreaVendors", fields: [areaId], references: [id]) // Add relation name
  riderRequests      RiderRequest[]

  // Approval workflow fields
  approvalStatus        VendorApprovalStatus         @default(PENDING)
  approvalDate          DateTime?
  approvedById          String?
  approvedBy            User?                        @relation("VendorApprovedBy", fields: [approvedById], references: [id])
  declineReason         String?
  verificationDocuments String[]                     @default([]) // Deprecated in favor of documents relation
  documents             VendorVerificationDocument[]
  submittedForApproval  Boolean                      @default(false)
  submittedAt           DateTime?
  addresses             Address[] // New relation to Address

  @@index([name])
  @@index([areaId])
  @@index([name, description])
  @@index([approvalStatus])
}

model VendorVerificationDocument {
  id        String   @id @default(uuid())
  vendorId  String
  type      String
  url       String
  createdAt DateTime @default(now())
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId])
}

model VendorOpeningHour {
  id        String    @id @default(uuid())
  vendorId  String
  day       DayOfWeek
  openTime  String?
  closeTime String?
  isClosed  Boolean   @default(false)
  vendor    Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([vendorId, day])
  @@index([vendorId])
}

model FavoriteVendor {
  id        String   @id @default(uuid())
  userId    String
  vendorId  String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([userId, vendorId])
  @@index([userId])
  @@index([vendorId])
}

model Product {
  id          String        @id @default(uuid())
  vendorId    String
  name        String
  description String?
  createdAt   DateTime      @default(now())
  inStock     Boolean       @default(true)
  image       String?
  vendor      Vendor        @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  items       ProductItem[]

  @@index([vendorId])
}

model ProductItem {
  id              String                @id @default(uuid())
  vendorId        String
  productId       String?
  name            String
  slug            String                @unique
  description     String?
  price           Float
  currency        String                @default("NGN")
  images          String[]              @default([])
  isActive        Boolean               @default(true)
  createdAt       DateTime              @default(now())
  inStock         Boolean               @default(true)
  
  // NEW FIELDS FOR FLEXIBLE QUANTITY
  pricingType     PricingType           @default(FIXED)
  unitName        String?               // "scoop", "wrap", "piece", "kg"
  minQuantity     Int                   @default(1)
  maxQuantity     Int?                  // optional limit
  quantityStep    Int                   @default(1) // for items sold in multiples
  
  orderItems      OrderItem[]
  orderItemAddons OrderItemAddon[]
  product         Product?              @relation(fields: [productId], references: [id], onDelete: Cascade)
  vendor          Vendor                @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  categories      ProductItemCategory[]

  @@index([vendorId])
  @@index([price])
  @@index([name, description])
}

model Category {
  id        String                @id @default(uuid())
  name      String                @unique
  slug      String                @unique
  createdAt DateTime              @default(now())
  image     String?
  items     ProductItemCategory[]
  vendors   VendorCategory[]

  @@index([name])
}

model ProductItemCategory {
  id            String      @id @default(uuid())
  productItemId String
  categoryId    String
  category      Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  productItem   ProductItem @relation(fields: [productItemId], references: [id], onDelete: Cascade)

  @@unique([productItemId, categoryId])
  @@index([categoryId])
  @@index([productItemId])
}

model VendorCategory {
  id         String   @id @default(uuid())
  vendorId   String
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  vendor     Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([vendorId, categoryId])
  @@index([categoryId])
  @@index([vendorId])
}

model Review {
  id        String   @id @default(uuid())
  userId    String
  vendorId  String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId])
  @@index([userId])
}

model Order {
  id              String        @id @default(uuid())
  userId          String
  vendorId        String?
  addressId       String
  operatorId      String?
  assignedRiderId String?
  status          OrderStatus   @default(PENDING)
  totalAmount     Float
  currency        String        @default("NGN")
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deliveryFee     Float         @default(0)
  serviceFee      Float         @default(0)
  payoutStatus    PayoutStatus  @default(NOT_ELIGIBLE)
  platformFee     Float         @default(0)
  productAmount   Float         @default(0)
  address         Address       @relation(fields: [addressId], references: [id])
  assignedRider   Rider?        @relation(fields: [assignedRiderId], references: [id])
  operator        Operator?     @relation(fields: [operatorId], references: [id])
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendor          Vendor?       @relation(fields: [vendorId], references: [id])
  items           OrderItem[]
  payment         Payment?
  vendorPayout    VendorPayout?

  @@index([userId])
  @@index([vendorId])
  @@index([operatorId])
  @@index([status])
}

model OrderItem {
  id            String           @id @default(uuid())
  orderId       String
  productItemId String
  quantity      Int              @default(1)
  unitPrice     Float
  totalPrice    Float
  groupKey      String?
  order         Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productItem   ProductItem      @relation(fields: [productItemId], references: [id])
  addons        OrderItemAddon[]

  @@index([orderId])
  @@index([productItemId])
}

model OrderItemAddon {
  id                 String      @id @default(uuid())
  orderItemId        String
  addonProductItemId String
  quantity           Int         @default(1)
  unitPrice          Float
  addonProductItem   ProductItem @relation(fields: [addonProductItemId], references: [id], onDelete: Cascade)
  orderItem          OrderItem   @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([orderItemId])
  @@index([addonProductItemId])
}

model Payment {
  id          String        @id @default(uuid())
  orderId     String        @unique
  userId      String
  amount      Float
  currency    String        @default("NGN")
  provider    String        @default("paystack")
  providerRef String
  status      PaymentStatus @default(PENDING)
  paidAt      DateTime?
  createdAt   DateTime      @default(now())
  metadata    Json?
  order       Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([providerRef])
}

model VendorPayout {
  id           String               @id @default(uuid())
  vendorId     String
  orderId      String               @unique
  amount       Float
  currency     String               @default("NGN")
  transferRef  String?
  transferCode String?
  status       PayoutTransferStatus @default(PENDING)
  initiatedAt  DateTime             @default(now())
  completedAt  DateTime?
  batchId      String?
  batch        PayoutBatch?         @relation(fields: [batchId], references: [id])
  order        Order                @relation(fields: [orderId], references: [id])
  vendor       Vendor               @relation(fields: [vendorId], references: [id])
  user         User?                @relation(fields: [userId], references: [id])
  userId       String?

  @@index([vendorId])
  @@index([status])
}

model PayoutBatch {
  id            String               @id @default(uuid())
  reference     String               @unique
  totalAmount   Float
  currency      String               @default("NGN")
  status        PayoutTransferStatus @default(PENDING)
  initiatedById String
  createdAt     DateTime             @default(now())
  completedAt   DateTime?
  initiatedBy   User                 @relation(fields: [initiatedById], references: [id])
  payouts       VendorPayout[]
}

model PhoneVerification {
  id        String   @id @default(uuid())
  phone     String
  otpHash   String
  expiresAt DateTime
  attempts  Int      @default(0)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone])
  @@index([createdAt])
}

model Referral {
  id             String         @id @default(uuid())
  referrerUserId String // User who has the referral code
  referredUserId String // User who signed up with code
  referralCode   String // The code used
  status         ReferralStatus @default(PENDING) // PENDING, CONFIRMED
  confirmedAt    DateTime? // When referred user completed signup
  createdAt      DateTime       @default(now())

  referrer User @relation("ReferrerReferrals", fields: [referrerUserId], references: [id], onDelete: Cascade)
  referred User @relation("ReferredByReferrals", fields: [referredUserId], references: [id], onDelete: Cascade)

  @@unique([referredUserId]) // One user can only be referred by one person
  @@index([referralCode])
  @@index([referrerUserId])
  @@index([status])
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PlatformSetting {
  id    String @id @default(uuid())
  key   String @unique
  value Json
}

model playing_with_neon {
  id    Int    @id @default(autoincrement())
  name  String
  value Float? @db.Real
}

enum Role {
  CUSTOMER
  VENDOR
  OPERATOR
  RIDER
  SUPER_ADMIN
}

enum OrderStatus {
  PENDING
  PAID
  PREPARING
  ASSIGNED
  DELIVERED
  CANCELLED
  ACCEPTED
  READY
  OUT_FOR_DELIVERY
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PayoutStatus {
  NOT_ELIGIBLE
  PENDING
  PAID
  FAILED
}

enum PayoutTransferStatus {
  PENDING
  SUCCESS
  FAILED
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum VendorApprovalStatus {
  PENDING
  APPROVED
  DECLINED
}

enum VendorAvailabilityStatus {
  AUTO
  OPEN
  CLOSED
}

enum ReferralStatus {
  PENDING
  CONFIRMED
}

enum RiderRequestStatus {
  PENDING
  ACCEPTED
  ASSIGNED
  READY
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum SettlementStatus {
  UNSETTLED
  PENDING_VERIFICATION
  SETTLED
}


enum PricingType {
  FIXED       // Traditional: price is for the whole item
  PER_UNIT    // New: price is per unit (scoop, wrap, etc.)
}